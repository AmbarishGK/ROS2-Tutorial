# docker/Dockerfile.jetson-ros2-vision
# Jetson (aarch64) image: CUDA 12.2 + PyTorch 2.1.0 + TF + ROS 2 Humble + MMDetection3D + YOLO
FROM dustynv/l4t-ml:r36.2.0

ENV DEBIAN_FRONTEND=noninteractive \
    TZ=UTC \
    LANG=en_US.UTF-8 \
    LC_ALL=en_US.UTF-8 \
    ROS_DISTRO=humble \
    PIP_NO_CACHE_DIR=1 \
    FORCE_CUDA=1

# -----------------------
# System + dev deps
# -----------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    locales tzdata ca-certificates gnupg2 lsb-release software-properties-common \
    build-essential cmake ninja-build git \
    curl wget vim nano \
    ffmpeg libgl1 libglib2.0-0 \
    iputils-ping net-tools less sudo \
 && locale-gen en_US.UTF-8 \
 && rm -rf /var/lib/apt/lists/*

# -----------------------
# Python tooling
# (L4T image already has Python + torch 2.1.0)
# -----------------------
RUN python3 -m pip install --upgrade pip

# Pin numpy first (what you are using now)
RUN python3 -m pip install --no-cache-dir "numpy==1.26.4"

# setuptools / packaging versions that work with colcon and mmdet3d
RUN python3 -m pip install --no-cache-dir \
    "setuptools>=65,<80" \
    "packaging>=24,<25" \
    "wheel>=0.38"

# Workaround: get rid of old distutils blinker (if any) and install a modern one
RUN python3 -m pip install --no-cache-dir --ignore-installed "blinker>=1.7"

# -----------------------
# Core ML libs: OpenMMLab + YOLO
# -----------------------
RUN python3 -m pip install --no-cache-dir \
    openmim==0.3.9 \
    mmengine==0.10.7

# Build mmcv 2.1.0 from source for Jetson (CUDA 12.2, sm_87)
WORKDIR /root
RUN git clone --depth 1 -b v2.1.0 https://github.com/open-mmlab/mmcv.git && \
    cd mmcv && \
    MMCV_WITH_OPS=1 FORCE_CUDA=1 TORCH_CUDA_ARCH_LIST="8.7" \
      python3 -m pip install . --no-build-isolation && \
    cd /root && rm -rf mmcv

# mmdet + mmdet3d (same as container)
RUN mim install "mmdet>=3.2.0,<3.3.0" "mmdet3d==1.4.0"

# Optional libs you already have
RUN python3 -m pip install --no-cache-dir \
    open3d==0.18.0 \
    plyfile==1.1.3 \
    pyquaternion==0.9.9 \
    tqdm==4.66.5

# YOLOv8 + OpenCV + gdown (match your versions)
RUN python3 -m pip install --no-cache-dir \
    "opencv-python==4.8.1.78" \
    "ultralytics==8.2.103" --no-deps \
    gdown

# -----------------------
# ROS 2 Humble desktop
# -----------------------
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl gnupg2 lsb-release ca-certificates \
 && rm -rf /var/lib/apt/lists/*

RUN set -e; \
    curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key \
      -o /usr/share/keyrings/ros-archive-keyring.gpg; \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/ros-archive-keyring.gpg] \
http://packages.ros.org/ros2/ubuntu $(. /etc/os-release && echo $UBUNTU_CODENAME) main" \
      > /etc/apt/sources.list.d/ros2.list

RUN apt-get update && apt-get install -y --no-install-recommends \
    ros-humble-desktop \
    ros-dev-tools \
    python3-colcon-common-extensions \
    python3-rosdep python3-vcstool \
 && rm -rf /var/lib/apt/lists/*

# rosdep init/update
RUN rosdep init 2>/dev/null || true && rosdep update

# -----------------------
# Workspace: mmdetection3d + ROS2-Tutorial
# -----------------------
WORKDIR /workspace

# Optional: mmdetection3d repo (for configs/demos; runtime uses pip mmdet3d)
RUN git clone -b dev-1.x --depth 1 https://github.com/open-mmlab/mmdetection3d.git /workspace/mmdetection3d

# ROS 2 packages (sparse checkout, like you did)
RUN git clone --depth 1 --filter=blob:none --no-checkout \
      https://github.com/AmbarishGK/ROS2-Tutorial.git /workspace/ROS2-Tutorial && \
    cd /workspace/ROS2-Tutorial && \
    git sparse-checkout init --cone && \
    git sparse-checkout set \
      mmdetect_lidar_demo \
      image_demo \
      ros2demo && \
    git checkout

# Get default PointPillars config + checkpoint (same as your manual mim download)
RUN mkdir -p /workspace/ROS2-Tutorial/checkpoints && \
    cd /workspace/ROS2-Tutorial && \
    mim download mmdet3d \
      --config pointpillars_hv_secfpn_8xb6-160e_kitti-3d-car \
      --dest checkpoints

# -----------------------
# Resolve ROS2 dependencies for those packages
# -----------------------
SHELL ["/bin/bash", "-lc"]

RUN source /opt/ros/${ROS_DISTRO}/setup.bash && \
    cd /workspace/ROS2-Tutorial && \
    rosdep install --from-paths . --ignore-src -r -y || true

# -----------------------
# Build the ROS2-Tutorial workspace packages
# -----------------------
RUN source /opt/ros/${ROS_DISTRO}/setup.bash && \
    cd /workspace/ROS2-Tutorial && \
    colcon build --symlink-install \
      --packages-select \
        ros2demo \
        image_demo \
        mmdetect_lidar_demo

# -----------------------
# Shell defaults
# -----------------------
ENV RMW_IMPLEMENTATION=rmw_cyclonedds_cpp \
    QT_X11_NO_MITSHM=1

RUN echo "source /opt/ros/${ROS_DISTRO}/setup.bash" >> /etc/bash.bashrc && \
    echo "if [ -f /workspace/ROS2-Tutorial/install/setup.bash ]; then source /workspace/ROS2-Tutorial/install/setup.bash; fi" >> /etc/bash.bashrc && \
    echo "cd /workspace/ROS2-Tutorial" >> /etc/bash.bashrc

WORKDIR /workspace/ROS2-Tutorial

CMD ["bash"]
